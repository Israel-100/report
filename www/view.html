<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>View|Incidents</title>
</head>
<style>
    body {
        font-family: Arial, sans-serif;
        background-image: url(./img/ChatGPT.png);
        background-size: cover;
        background-position: center;
        display: flex;
        justify-content: center;
        align-items: center;
        margin: 0;
        padding: 0;
        flex-direction: column;
        min-height: 100vh;
    }

    h2 {
        text-align: center;
        margin-bottom: 10px;
    }

    #top-bar {
        text-align: center;
        margin-bottom: 20px;
    }

    #refreshBtn {
        background: #212923;
        color: #fff;
        border: none;
        border-radius: 6px;
        padding: 8px 16px;
        cursor: pointer;
        font-size: 14px;
        transition: background 0.3s ease;
    }

    #refreshBtn:hover {
        background: #11161238;
    }

    #incidents {
        max-width: 600px;
        margin: auto;
    }

    .incident {
        border: 1px solid #ddd;
        background: #fff;
        padding: 15px;
        margin-bottom: 15px;
        border-radius: 8px;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
    }

    .incident img {
        max-width: 100%;
        border-radius: 10px;
        margin-top: 10px;
    }

    .incident h3 {
        margin-top: 0;
    }

    .btn-group {
        margin-top: 10px;
    }

    .incident button {
        margin-right: 8px;
        padding: 6px 14px;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-size: 14px;
        transition: background 0.3s ease;
    }

    .btn-edit {
        background: #182029;
        color: white;
    }

    .btn-edit:hover {
        background: #0056b3;
    }

    .btn-delete {
        background: #dc3545;
        color: white;
    }

    .btn-delete:hover {
        background: #b02a37;
    }

    /* üîπ Navbar */
    .navbar {
        width: 100%;
        background: #182029;
        color: white;
        padding: 14px 20px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        box-shadow: 0 3px 6px rgba(0, 0, 0, 0.1);
        position: fixed;
        top: 0;
        left: 0;
        z-index: 1000;
    }

    .nav-left {
        font-size: 20px;
        font-weight: bold;
    }

    .nav-links {
        display: flex;
        gap: 15px;
        padding-right: 20px;
        /* spacing at the end */
        transition: max-height 0.3s ease-in-out;
    }

    .nav-links a {
        color: white;
        text-decoration: none;
        font-size: 15px;
        padding: 8px 12px;
        border-radius: 6px;
        transition: background 0.3s;
    }

    .nav-links a:hover {
        background: rgba(255, 255, 255, 0.2);
    }

    .nav-links a.active {
        background: rgba(255, 255, 255, 0.3);
        font-weight: bold;
    }

    /* üîπ Mobile menu toggle */
    .menu-toggle {
        display: none;
        background: none;
        border: none;
        cursor: pointer;
        margin-left: auto;

    }

    .menu-toggle img {
        width: 60px;
        /* adjust size */
        height: 30px;
        filter: invert(100%);
        /* makes icons white if they're black */
    }

    @media (max-width: 768px) {
        .menu-toggle {
            display: block;
        }
    }


    @media (max-width: 768px) {
        .nav-links {
            display: none;
            flex-direction: column;
            background: #182029;
            position: absolute;
            top: 60px;
            right: 0;
            width: 230px;
            padding: 12px;
            border-radius: 0 0 8px 8px;
        }

        .nav-links.show {
            display: flex;
            animation: slideDown 0.3s ease-in-out;
        }

        .menu-toggle {
            display: block;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
    }

    footer {
        background: #182029;
        color: azure;
        text-align: center;
        padding: 15px;
        position: fixed;
        bottom: 0;
        left: 0;
        width: 100%;
        font-size: 14px;
    }
</style>

<body>
    <div class="navbar">
        <div class="nav-left">Incident Reporter</div>

        <!-- Toggle Button -->
        <button class="menu-toggle" onclick="toggleMenu()" aria-label="Menu">
            <!-- Your downloaded hamburger SVG -->
            <img id="menuIcon" src="img/hamburger-menu-mobile-svgrepo-com.svg" alt="Menu" />
            <!-- Your downloaded close (X) SVG -->
            <img id="closeIcon" src="img/burger-menu-right-svgrepo-com.svg" alt="Close" style="display: none;" />
        </button>

        <div class="nav-links">
            <!-- <a href="signup.html">Signup</a>
            <a href="login.html">Login</a> -->
            <a href="index.html">Home </a>
            <a href="addreport.html">Add Incident</a>
            <a href="#" id="logoutBtn">Logout</a>
        </div>
    </div>

    <h2>My Incidents</h2>
    <div id="top-bar">
        <button id="refreshBtn" onclick="loadIncidents()">Refresh</button>
     
        <select id="filterCategory" title="categories" onchange="loadIncidents(this.value)">
            <option value="">All Categories</option>
            <option value="18">Accident</option>
            <option value="19">Fire</option>
            <option value="28">Robbery</option>
            <option value="20">Traffic</option>
        </select>
    </div>

    <div id="incidents">
        <p style="text-align:center;">Loading...</p>
    </div>
    <footer>
        <p style="margin: 0;">&copy; 2025 Incident Reporting App</p>
    </footer>

</body>


<script>

    // ‚úÖ WordPress REST API base URL
    const API_BASE = "https://report.byethost24.com/wp-json/wp/v2";

    // ‚úÖ Load incidents for logged-in user
    async function loadIncidents(categoryId = "") {
        let token = localStorage.getItem("token");
        let container = document.getElementById("incidents");

        if (!token) {
            container.innerHTML = "<p style='color:red;text-align:center;'>Please login first.</p>";
            return;
        }

        try {
            // ‚úÖ Get logged-in user info
            let userRes = await fetch(`${API_BASE}/users/me`, {
                headers: { "Authorization": "Bearer " + token }
            });
            if (!userRes.ok) throw new Error("Failed to get user info");
            let userData = await userRes.json();
            let userId = userData.id;

            // ‚úÖ Build API URL
            let url = `${API_BASE}/posts?author=${userId}&_embed&per_page=20&orderby=date&order=desc`;
            if (categoryId) url += `&categories=${categoryId}`;

            // ‚úÖ Fetch posts
            let response = await fetch(url, {
                headers: { "Authorization": "Bearer " + token }
            });
            if (!response.ok) throw new Error("Failed to load posts");

            let posts = await response.json();
            container.innerHTML = "";

            if (!Array.isArray(posts) || posts.length === 0) {
                container.innerHTML = "<p style='text-align:center;'>No incidents found.</p>";
                return;
            }

            // ‚úÖ Loop through incidents
            posts.forEach(post => {
                let contentHtml = post.content.rendered || "";

                // ‚úÖ Featured Image
                let featuredImage = "";
                if (
                    post._embedded &&
                    post._embedded["wp:featuredmedia"] &&
                    post._embedded["wp:featuredmedia"][0] &&
                    post._embedded["wp:featuredmedia"][0].source_url
                ) {
                    let media = post._embedded["wp:featuredmedia"][0];
                    featuredImage = `<img src="${media.source_url}" alt="Incident image" class="incident-img">`;
                }

                // ‚úÖ If content doesn‚Äôt already contain the image, prepend it
                if (featuredImage && !contentHtml.includes("incident-img")) {
                    contentHtml = featuredImage + "<br>" + contentHtml;
                }

                // ‚úÖ Categories
                let categories = [];
                if (post._embedded && post._embedded["wp:term"]) {
                    categories = post._embedded["wp:term"][0].map(cat => cat.name);
                }
                let catHtml = categories.length ? `<p><strong>Category:</strong> ${categories.join(", ")}</p>` : "";

                // ‚úÖ Render incident card
                container.innerHTML += `
                <div class="incident">
                  <h3>${post.title.rendered}</h3>
                  <div class="incident-content">${contentHtml}</div>
                  ${catHtml}
                  <div class="btn-group">
                    <button class="btn-edit" onclick="editIncident(${post.id})">Edit</button>
                    <button class="btn-delete" onclick="deleteIncident(${post.id})">Delete</button>
                  </div>
                </div>
            `;
            });

        } catch (err) {
            container.innerHTML = "<p style='color:red;text-align:center;'>Error loading incidents.</p>";
            console.error("Load error:", err);
        }
    }

    // ‚úèÔ∏è EDIT INCIDENT
    async function editIncident(postId) {
        const token = localStorage.getItem("token");
        if (!token) {
            alert("Please login first");
            return;
        }

        try {
            const res = await fetch(`${API_BASE}/posts/${postId}?_embed`, {
                headers: { "Authorization": "Bearer " + token }
            });
            if (!res.ok) throw new Error("Failed to fetch post");

            const post = await res.json();

            // Show the Add/Edit form
            showAddIncident();

            // ‚úÖ Fill in fields
            document.getElementById("incidentId").value = post.id;
            document.getElementById("title").value = post.title.rendered;

            // ‚úÖ Extract description text (remove HTML but keep "Location")
            const parser = new DOMParser();
            const html = parser.parseFromString(post.content.rendered, "text/html");
            let text = html.body.textContent || "";
            document.getElementById("description").value = text.replace(/Location:.*/i, "").trim();

            // ‚úÖ Extract Location
            let locMatch = text.match(/Location:\s*(.+)$/i);
            document.getElementById("location").value = locMatch ? locMatch[1].trim() : "";

            // ‚úÖ Preview Featured Image
            if (
                post._embedded &&
                post._embedded["wp:featuredmedia"] &&
                post._embedded["wp:featuredmedia"][0] &&
                post._embedded["wp:featuredmedia"][0].source_url
            ) {
                document.getElementById("preview").src = post._embedded["wp:featuredmedia"][0].source_url;
                document.getElementById("preview").style.display = "block";
            } else {
                document.getElementById("preview").style.display = "none";
            }

            console.log("Editing incident:", post);
        } catch (err) {
            alert("Failed to fetch incident");
            console.error("Edit error:", err);
        }
    }

    // üóëÔ∏è Delete incident
    async function deleteIncident(postId) {
        if (!confirm("Are you sure you want to delete this incident?")) return;

        try {
            let token = localStorage.getItem("token");
            if (!token) {
                alert("Please login first");
                return;
            }

            let res = await fetch(`${API_BASE}/posts/${postId}?force=true`, {
                method: "DELETE",
                headers: { "Authorization": "Bearer " + token }
            });

            if (res.ok) {
                alert("Incident deleted successfully!");
                loadIncidents();
            } else {
                let data = await res.json();
                console.error("Delete failed:", data);
                alert("Delete failed: " + (data.message || "Unknown error"));
            }
        } catch (err) {
            console.error("Delete error:", err);
            alert("Delete request failed.");
        }
    }

    // ‚úÖ Run on page load
    document.addEventListener("DOMContentLoaded", () => loadIncidents());



    function toggleMenu() {
        const navLinks = document.querySelector(".nav-links");
        const menuIcon = document.getElementById("menuIcon");
        const closeIcon = document.getElementById("closeIcon");

        navLinks.classList.toggle("show");

        if (navLinks.classList.contains("show")) {
            menuIcon.style.display = "none";
            closeIcon.style.display = "block";
        } else {
            menuIcon.style.display = "block";
            closeIcon.style.display = "none";
        }
    }


    // üîπ Logout button logic
    if (localStorage.getItem("token")) {
        document.getElementById("logoutBtn").style.display = "inline";
    } else {
        document.getElementById("logoutBtn").style.display = "inline";
    }
    document.getElementById("logoutBtn").addEventListener("click", () => {
        localStorage.removeItem("token");
        alert("Logged out!");
        window.location.href = "index.html";
    });

    document.addEventListener("DOMContentLoaded", () => {
        if (localStorage.getItem("autoLoad") === "true") {
            loadIncidents();
            localStorage.removeItem("autoLoad"); // clear so it doesn‚Äôt run every time
        }
    });

</script>
<script src="cordova.js"></script>
<script type="module" src="js/index.js"></script>

</body>

</html>